import sys

import requests
import json


#获取原始数据
def list_get(data):
	url = "https://mb-api.abuse.ch/api/v1/"

	proxys = {}
	# proxys = {'https': 'http://127.0.0.1:7890'}
	respTxt = requests.post(url, data=data, timeout=900, proxies=proxys).text

	jsondata = json.loads(respTxt)
	status=jsondata['query_status']
	# 输出查询状态
	# 打印请求状态
	print('status:' + status)

	if status!='ok':
		sys.exit(0)

	data_list = jsondata['data']
	# 打印请求到的数据
	# print('data:' + str(data_list))

	return data_list


def sha256_list_get(data_list):
	# list[0]表示某软件全部信息，是字典
	# data_list[0]['sha256_hash']是它的sha256值
	sha256_list = []
	for i in data_list:
		sha256_list.append(i['sha256_hash'])
		# print(i['sha256_hash'])
	print(sha256_list)
	return sha256_list


def query_signature(signature_name, limit):
	data = {'query': 'get_siginfo', 'signature': signature_name, 'limit': limit}
	list = (list_get(data))
	return list


def query_tag(tag_name, limit):
	data = {'query': 'get_taginfo', 'tag': tag_name, 'limit': limit}
	list = (list_get(data))
	return list

def query_yara_rule(yara_rule, limit):
	data = {'query': 'get_yarainfo', 'yara_rule': yara_rule, 'limit': limit}
	list = (list_get(data))
	print(list[0])
	return list

def tag_filter(tag,list):
	if tag=='':
		return sha256_list_get(list)
	else:
		sha256_list=[]
		for item in list:
			# print(item['tags'])
			if tag in item['tags']:
				sha256_list.append(item['sha256_hash'])
		print(f"filter to {len(sha256_list)} malware with tag {tag}")
		return sha256_list

def file_type_filter(file_type,list):
	if file_type=='':
		return sha256_list_get(list)
	else:
		sha256_list=[]
		for item in list:
			# print(item['file_type'])
			if file_type == item['file_type']:
				sha256_list.append(item['sha256_hash'])
		print(f"filter to {len(sha256_list)} malware with filetype {file_type}")
		return sha256_list


if __name__ == '__main__':
	limit = 100
	list1 = file_type_filter('exe',query_yara_rule('Njrat', limit))
	# locals()['query_yara_rule']('Njrat', limit)
