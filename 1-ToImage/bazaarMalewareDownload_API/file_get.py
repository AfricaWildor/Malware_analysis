import os
from MalewareDownload_API.args_get import *


def download(sha256_list, dir_name):
	for sha256_hash in sha256_list:
		path = '.././FILE_DATABASE/' + dir_name + sha256_hash + '.zip'
		if not os.path.exists(path):
			data = {'query': 'get_file', 'sha256_hash': sha256_hash}
			url = "https://mb-api.abuse.ch/api/v1/"
			resp = requests.post(url, data=data)
			# 下载 要写入content而非text
			print('下载路径：'+path)
			with open(path, "wb") as code:
				code.write(resp.content)
		else:
			print(path+'已存在')

def make_dir(dir_name):
	path = '.././FILE_DATABASE/' + dir_name
	if not os.path.exists(path):  # 是否存在这个文件夹
		os.makedirs(path)  # 如果没有这个文件夹，那就创建一个


if __name__ == '__main__':
	query = {
		"signature": 'CoinMiner',
		"tag": ''
	}
	limit_item=500
	query_param = ['signature', 'tag']
	for key, value in query.items():
		if (key in query_param and value != ''):
			category = f'{key}/{value}/'
			make_dir(category)
			# 方法名替换待解决
			file_list=query_signature(value,limit_item)
			print(file_list)
			download(file_list,category)