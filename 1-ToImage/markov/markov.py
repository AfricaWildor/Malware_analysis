from PIL import Image, ImageDraw
import os, sys, array, math
import numpy as np


def file2arr(bytearr, file_save_path):
    buffer = array.array('B', bytearr)
    #print(buffer)

    array1 = np.zeros((256, 256), dtype=int)

    for i in range(len(buffer) - 2):
        j = i + 1
        array1[buffer[i]][buffer[j]] += 1

    trun_array = np.zeros(256, dtype=int)
    for i in range(256):
        for j in range(256):
            trun_array[i] += array1[i][j]

    array2 = np.zeros((256, 256), dtype=float)
    for i in range(256):
        for j in range(256):
            if trun_array[i] != 0:
                array2[i][j] = array1[i][j] / trun_array[i]

    # print(array2)

    array3 = np.zeros((256, 256), dtype=int)
    for i in range(256):
        for j in range(256):
            rgb = math.ceil(255 * array2[i][j])
            array3[i][j] = rgb

    img = Image.fromarray(array3.astype("uint8"))

    img.save(file_save_path)


if __name__ == '__main__':

    file_list = os.listdir("E:/malware-classification/train")
    #arr = np.load("./hilbert.npy")
    #n = 8
    #dim = 2 ** n

    for file in file_list:
        if file.find(".bytes") >= 0:
            bytes_list = b''
            line = 0
            with open(os.path.join("E:/malware-classification/train", file), mode="r") as f:
                for l in f:
                    if l.find("?") >= 0:
                        continue
                    str_list = l.split(" ")[1:]
                    b = bytes.fromhex("".join(str_list))
                    bytes_list += b
                    line = line + 1
                    if line == 4096:
                        break

            if len(bytes_list) == 0:
                    print(f"{file} is empty")
                    continue

            file2arr(bytes_list,"E:/malware-classification/train_img2/"+file+".png")
            print(file+".png"+" done!")

    # bytes_list = b''
    # line = 0
    # with open(os.path.join("./", "0ACDbR5M3ZhBJajygTuf.bytes"), mode="r") as f:
    #     for l in f:
    #         if l.find("?") >= 0:
    #             continue
    #         str_list = l.split(" ")[1:]
    #         b = bytes.fromhex("".join(str_list))
    #         bytes_list += b
    #         line = line + 1
    #         if line == 4096:
    #             break
    #     file2arr(bytes_list,"./a.png")
