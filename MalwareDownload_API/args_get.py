import sys
import requests
import json
from list_filter import *

import gol

proxys = gol.proxys


#获取原始数据
def list_get(data):
	url = "https://mb-api.abuse.ch/api/v1/"

	respTxt = requests.post(url, data=data, timeout=900, proxies=proxys).text

	jsondata = json.loads(respTxt)
	status=jsondata['query_status']
	# 输出查询状态
	# 打印请求状态
	print('args_get status:' + status)

	if status!='ok':
		sys.exit(0)

	data_list = jsondata['data']
	# 打印请求到的数据
	# print('data:' + str(data_list))

	return data_list


def sha256_list_get(data_list):
	# list[0]表示某软件全部信息，是字典
	# data_list[0]['sha256_hash']是它的sha256值
	sha256_list = []
	for i in data_list:
		sha256_list.append(i['sha256_hash'])
		# print(i['sha256_hash'])
	print(sha256_list)
	return sha256_list


def query_signature(signature_name, limit):
	print('get Malwarelist with signature_name '+signature_name)
	data = {'query': 'get_siginfo', 'signature': signature_name, 'limit': limit}
	list = (list_get(data))
	print(f"found {len(list)} malware with signature {signature_name}")
	return list


def query_tag(tag_name, limit):
	print('get Malwarelist with tag '+tag_name)
	data = {'query': 'get_taginfo', 'tag': tag_name, 'limit': limit}
	list = (list_get(data))
	return list

def query_yara_rule(yara_rule, limit):
	print('get Malwarelist with yara_rule '+yara_rule)
	data = {'query': 'get_yarainfo', 'yara_rule': yara_rule, 'limit': limit}
	list = (list_get(data))
	print(list[0])
	return list




if __name__ == '__main__':


	limit = 100
	list1 = tag_filter(['exe', 'NjRAT'], query_yara_rule('Njrat', limit),True)
	locals()['query_yara_rule']('Njrat', limit)
